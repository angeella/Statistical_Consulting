---
title: Measuring the effect of different political actions to contrast the contagion
  of COVID19
author: "Angela Andreella, Michele Lambardi, Silvia De Nicolo"
date: "March 22, 2005"
output:
  beamer_presentation:
    incremental: yes
  ioslides_presentation:
    incremental: yes
    theme: cosmo
    transition: slower
  slidy_presentation:
    incremental: yes
---

```{r setup, include=FALSE}
<<<<<<< HEAD
rm(list = ls())
path <- "~/GitHub/Statistical_Consulting/" #Insert your path
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
source(paste0(path, "Angela/packages.R"))
=======
knitr::opts_chunk$set(echo = TRUE)
>>>>>>> parent of 082075c... update
```

## Data

```{r include = FALSE}
rm(list = ls())
#source("~/GitHub/Statistical_Consulting/Angela/load_DB.R")
source("~/GitHub/Statistical_Consulting/Angela/packages.R")
load("~/GitHub/Statistical_Consulting/Angela/out.RData")
```


## Worldwide case

## Motivation

<<<<<<< HEAD
```{r, echo=FALSE, warning = FALSE, comment = FALSE, silent = T}
load(paste0(path, "Presentation/Data/out.RData"))
a <- ggplot(dat, aes(x = date, y = active/1000, group = Clusters, color = Clusters)) + geom_smooth(method = 'loess',formula = 'y ~ x') + scale_x_date(date_labels = "%b %d") + theme_classic() + ylab("Cumulated Active per 1000") + xlab("Date") 
=======
```{r pressure, echo=FALSE, warning = FALSE, comment = FALSE}
a <- ggplot(dat_shape, aes(x = date, y = active/1000, group = Clusters, color = Clusters)) + geom_smooth() + scale_x_date(date_labels = "%b %d") + theme_classic() + ylab("Active per 1000") + xlab("Date") 
>>>>>>> parent of 082075c... update

ggplotly(a)
```

## Analysis

<<<<<<< HEAD
## Model {data-background=back.jpg data-background-size=cover .flexbox .vcenter}

<center>
<span style="color:rgb(17,57,219);">GENERALIZED POISSON MIXED MODEL for Overdispersed Count Data</span>
</div> 
</center>

**WHY?**

- We analyze the number of **Active person**, i.e., Confirmed - Deaths - Recovered $\rightarrow$ **Count Dependent Variable** (Generalized Poisson Model);


- The data are observed for each **country nested within clusters** during $103$ **days** $\rightarrow$ **Mixed Model**.


## Which policies acted better? {data-background=back.jpg data-background-size=cover .flexbox .vcenter}

```{r,echo=FALSE, warning = FALSE, comment = FALSE, silent = T}
out0 <- ggeffect(mod1, terms = c(var_LD[c(2,4:6)]))

out0 <- as.data.frame(ggeffect(mod1, terms = "workplace_closingF"))
out0$Value <- c("No measures", "Recommend closing or work from home", "require closing for some sector" ,"Require closing all-but-essential workplaces")
out1 <-as.data.frame(ggeffect(mod1, terms = "gatherings_restrictionsF"))
out1$Value <- c("No measures", "> 1000", "100-1000 people", "10-100 people", "< 10 people")
out2 <- as.data.frame(ggeffect(mod1, terms = "transport_closingF"))[c(1,3),]
out2$Value <- c("No measures", "Require closing")
out3 <- as.data.frame(ggeffect(mod1, terms = "stay_home_restrictionsF"))[c(1,4),]
out3$Value <- c("No measures", "Minimal exceptions")
out4 <- as.data.frame(ggeffect(mod1, terms = "testing_policyF"))
out4$Value <- c("No measures", "Specific criteria", "Symptoms", "Open")
out5 <- as.data.frame(ggeffect(mod1, terms = "contact_tracingF"))
out5$Value <- c("No measures", "Limited", "Comprehensive")

OUT <- rbind(out0, out1, out2, out3, out4, out5)
OUT$Policies <- c(rep("Workplace Closing", nrow(out0)),
                  rep("No Gathering", nrow(out1)),
                  rep("No Transport", nrow(out2)),  
                  rep("Stay Home", nrow(out3)),
                  rep("Testing", nrow(out4)),
                  rep("Tracing", nrow(out5)))

colnames(OUT)[1] <- "Strength"

#OUT$cols <- c("slateblue1", "slateblue2", "slateblue3", "slateblue4")

ggplot(OUT, aes(Policies, predicted, fill = Strength)) +
  geom_bar(stat = "summary", fun = "mean", 
           position = position_dodge(width = 0.9)) +
  scale_y_continuous(name = "Predicted counts of Active People after 14 days", limits = c(0, 1700))+ geom_errorbar(stat = "summary", fun.data = "mean_sdl", 
                fun.args = list(mult = 2),
                position =  position_dodge(width =1)) +
  geom_text(aes(label=Value, group = Strength),     hjust = -0.1, size = 3,
            position = position_dodge(width = 1),
            inherit.aes = TRUE)  + coord_flip() + scale_fill_viridis(discrete=T) +
  theme_minimal() + ylab("") 
```

## Who acted promptly? {data-background=back.jpg data-background-size=cover .flexbox .vcenter}

```{r echo=FALSE, warning = FALSE, comment = FALSE, silent = T}
load(paste0(path, "Presentation/Data/plot_map.RData"))
grid.arrange(na2, europe2,                 
             arrangeGrob(kor2, sin2, nrow = 2, ncol=1),
             ncol = 3, nrow=1, widths=c(3,4,2))    
```

## Who acted promptly? {data-background=back.jpg data-background-size=cover .flexbox .vcenter}

```{r, echo=FALSE, warning = FALSE, comment = FALSE, silent = T}
load(paste0(path, "Presentation/Data/plot_mod.RData"))

subplot(ggplotly(p1, tooltip = c("colour", "y")) %>% layout(showlegend = FALSE, title = ""),
 ggplotly(p2, tooltip = c("colour", "y"))%>% layout(showlegend = FALSE,title = ""), 
ggplotly(p3, tooltip = c("colour", "y")) %>% layout(showlegend = FALSE, title = "Stay Home           Testing            Tracing"), shareY = T
) 
```

## Take home message {data-background=back.jpg data-background-size=cover .flexbox .vcenter}



- <span style="color:rgb(17,57,219);">Lockdown policies work!</span> respect to impose no measure;

- Strong Testing and Tracing policies lead to discovering more infected people (luckily!)



- **Korea and Singapore are the best countries that acted properly**;

- Sweden, Germany, Portugal, and Greece better than the other UE countries;

- The USA, and Canada better than the other UE countries except for Sweden and Germany.


# Italy Case {data-background=covid.jpg data-background-size=cover}

## Introduction {data-background=back.jpg data-background-size=cover .flexbox .vcenter}

<div class="blue2">Background</div>


* Italian **regions**, ethernal **divide**

* Lockdown almost simultaneous, excepted the **Red Zone**

* First cases in **Lombardia** and **Lazio** hubs

<div class="blue2">Problems</div>


* Policies have **no variability** between regions

* **Baseline control**: some regions start from worse situations

* Cannot estimates some effects as for the nations case

* To our defense, integration between databases came lately

* Instrumental variables, more correct but tricky approach


## Approach {data-background=back.jpg data-background-size=cover .flexbox .vcenter}

* **Phase "1" versus Phase "0"** comparison


* **Auto-regression**: modelling active cases given past numbers
   * Related but not quite to the R0 index
   
* **Random effects** for region and date, standard panel approach


* Assuming policies effects seen **~14 days later**


* Controlling for **testing** frequency

```{r, warning=FALSE, echo = FALSE, include = FALSE}
load(paste0(path, "Presentation/Data/finaleregioni.RData"))
load(paste0(path, "Presentation/Data/maps.RData"))
map <- map %>% filter(country=="Italy")

npaz <- 30

dat <- dat %>%
   mutate(
      monthspoint=14/30*log(npaz/active)/log(ratepoint),
      monthslower=14/30*log(npaz/active)/log(ratelower),
      monthsupper=14/30*log(npaz/active)/log(rateupper)
   )

last <- dat %>%
   filter(date==max(date)) %>%
   left_join(map, by="region") %>%
   st_as_sf()
```

## Speed of contagion {data-background=back.jpg data-background-size=cover .flexbox .vcenter}

```{r, warning=FALSE, echo = FALSE}
last %>%
   arrange(ratepoint) %>%
   mutate(region=factor(region, levels=region)) %>%
   ggplot(aes(x=ratepoint, y=region)) +
   geom_point(aes(x=ratepoint)) +
   geom_errorbar(aes(xmin=ratelower, xmax=rateupper, group=region)) +
   geom_text(aes(x=ratelower, label=paste(region, " ")), hjust="right") +
   theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill="white"),
        panel.grid.major.x = element_line(color="grey"),
        panel.grid.minor.x = element_line(color="lightgrey"),
        # panel.grid.major.y = element_line(color="grey"),
        legend.position = "none") +
   xlab("active cases in two weeks, expected") +
   scale_x_continuous(limits = c(0,1), labels = function(x) paste0(ifelse(x<1,"","+"), (x-1)*100, "%")) # Multiply by 100 
=======
 - We analyze the **Active person**, i.e., Confirmed - Deaths - Recovered $\rightarrow$ **Count** Dependent Variable (Generalized Poisson Model);
 
 
 - The data are observed for each country nested within clusters during $103$ days $\rightarrow$ Mixed Model;
 
 
GENERALIZED POISSON MIXED MODEL for Overdispersed Count Data 

## Which policies acted better?

```{r echo = FALSE}
out0 <- ggeffect(mod1, terms = "school_closingF")[c(1,3),]
out1 <- ggeffect(mod1, terms = "gatherings_restrictionsF")[c(1,3),]
out2 <- ggeffect(mod1, terms = "transport_closingF")[c(1,2),]
out3 <- ggeffect(mod1, terms = "stay_home_restrictionsF")[c(1,4),]
out4 <- ggeffect(mod1, terms = "internal_movement_restrictionsF")[c(1,2),]
out5 <- ggeffect(mod1, terms = "testing_policyF")
out6 <- ggeffect(mod1, terms = "contact_tracingF")

OUT <- rbind(out0, out1, out2, out3, out4, out5, out6)
OUT$Policies <- c(rep("School Closing", nrow(out0)),
             rep("No Gathering", nrow(out1)),
             rep("No Transport", nrow(out2)),  
             rep("Stay Home", nrow(out3)),
             rep("No Movement", nrow(out4)),  
             rep("Testing", nrow(out5)),
             rep("Tracing", nrow(out6)))

colnames(OUT)[1] <- "Strength"
Value <- c("No measures",  "Require closing",
               "No measures",  "< 10 people",
           "No measures", "Recommend closing",
               "No measures", "Minimal exceptions",
               "No measures", "Recommend closing", 
               "No measures", "Specific criteria", "Symptoms", "Open public", "No measures", "Limited", "Comprehensive")

a<-ggplot(data=OUT, aes(x=Policies, y=predicted,fill = Strength, color = Strength)) +
  geom_bar(stat="identity",  position="dodge") +
    scale_color_viridis(discrete = TRUE, option = "D")+
scale_fill_viridis(discrete = TRUE) +
 # theme_minimal()+  xlab("Active Predicted")+
  geom_text(
    aes(x = Policies, y = round(predicted), label = round(predicted), group = Strength),
     hjust = -0.5, size = 3,
    position = position_dodge(width = 1),
    inherit.aes = TRUE
  )  +  
#  geom_text(colour="black", aes(y=-1000, label=Value,  vjust = .5),  position=position_dodge(width=1), hjust=-.1,inherit.aes = TRUE) +
 theme_minimal() +
  theme(axis.title.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x =element_blank()) + coord_flip()
ggplotly(a)
>>>>>>> parent of 082075c... update
```

## Who acted promptly?

```{r echo = FALSE}
pr<-ggeffect(mod1, "Clusters")

world <- ne_countries(scale = "medium", returnclass = "sf") 
world$id <- world$iso_a3 

dat_shape$confFIT <- ifelse(dat_shape$Clusters == "Cl1", pr$predicted[1],
                    ifelse(dat_shape$Clusters == "Cl2", pr$predicted[2],
                           ifelse(dat_shape$Clusters == "Cl3", pr$predicted[3],
                                  ifelse(dat_shape$Clusters == "Cl4", pr$predicted[4], pr$predicted[5]))))

datMap <- left_join(world, dat_shape, by="id")

a<-ggplot(data = datMap) + geom_sf(aes(fill = confFIT))
ggplotly(a)
```


## Take home message

